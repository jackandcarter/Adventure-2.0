{\rtf1\ansi\ansicpg1252\cocoartf2865
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 # Unity Client Architecture\
\
## Goals\
\
- 2D top-down SNES-style client in **Unity 6.2**.\
- Strict separation of:\
  - View (Unity GameObjects, sprites, animations, UI)\
  - State (client-side model mirrored from server)\
  - Networking (connection and message handling)\
- **Editor-first UI**:\
  - All major UI canvases and layouts are created in the Unity editor.\
  - Code does NOT create new canvases or full UI hierarchies at runtime.\
  - Code may only:\
    - Bind to existing UI elements.\
    - Instantiate small UI element prefabs within existing layout containers.\
\
## Suggested Assemblies / Namespaces\
\
Use assembly definitions for modularity and to avoid circular deps.\
\
- `AdventureBot.Client.Core`\
  - Game bootstrap, global managers, scene transitions.\
- `AdventureBot.Client.Networking`\
  - Network client, message definitions, handlers.\
- `AdventureBot.Client.Gameplay`\
  - Player/Enemy views, dungeon visual logic, camera.\
- `AdventureBot.Client.UI`\
  - UI controllers, view models, binding logic.\
- `AdventureBot.Client.Content`\
  - ScriptableObjects for client-side visual data: icons, sprites, SFX, etc.\
\
## Core Components\
\
### GameBootstrap\
\
**Scene:** `Bootstrap`\
\
Responsibilities:\
\
- Initialize persistent singletons:\
  - `NetworkClient`\
  - `GameStateClient`\
  - `SceneController`\
  - `InputManager`\
  - `AudioManager`\
  - `UIRoot` (optional persistent overlay)\
- Load `MainMenu` scene additively once initialized.\
- Ensure this GameObject is marked `DontDestroyOnLoad`.\
\
### NetworkClient (Client-Side)\
\
Responsibilities:\
\
- Connect/disconnect to server (host/port configurable).\
- Send/receive JSON messages.\
- Reconnect logic if connection drops (later).\
- Queue outgoing messages; dispatch incoming messages to handlers.\
\
Implementation details:\
\
- Provide async methods:\
  - `ConnectAsync(string host, int port)`\
  - `SendAsync(GameMessageBase message)`\
- Provide events:\
  - `OnConnected`, `OnDisconnected`\
  - `OnMessageReceived(GameMessageBase message)`\
\
### GameStateClient\
\
Responsibilities:\
\
- Hold the client\'92s current view of game state:\
  - Logged in account.\
  - Selected character.\
  - Lobby state:\
    - List of online players.\
    - Party membership.\
    - Recent chat messages.\
  - Current dungeon:\
    - Room graph + which rooms are discovered.\
    - Player and enemy positions (client view).\
    - Active combat events, status effects (client view).\
\
- Provide events/hooks for UI and View to subscribe to:\
  - `OnAccountStateChanged`\
  - `OnLobbyStateUpdated`\
  - `OnPartyStateUpdated`\
  - `OnChatMessageReceived`\
  - `OnDungeonStateUpdated`\
  - `OnCombatEventReceived`\
\
> Codex: Implement this as a plain C# class with events; it should not be a MonoBehaviour.\
\
### PlayerController (Client)\
\
There are two conceptual layers:\
\
- **Local Player Input Controller**\
  - Reads input actions (movement, attack, ability use).\
  - Sends commands to server: movement intentions, ability cast requests.\
  - May perform simple client-side prediction.\
\
- **PlayerView**\
  - A MonoBehaviour on `PlayerCharacter` prefab.\
  - Receives authoritative position/state updates from GameStateClient.\
  - Applies animations, sprite direction, and VFX.\
\
### Remote Players\
\
Other players are represented as the same `PlayerCharacter` prefab with:\
\
- No local input controller.\
- A `NetworkEntityClient` component that:\
  - Interpolates between positions received from server.\
  - Updates animations accordingly.\
\
### DungeonView & RoomView\
\
- `DungeonView`:\
  - Lives in the Dungeon scene.\
  - Responsible for:\
    - Receiving dungeon layout from GameStateClient.\
    - Instantiating appropriate **room prefabs** (prefabs built in editor).\
    - Managing active room (camera focus).\
    - Spawning entities (players, enemies, chests) within appropriate rooms.\
\
- `RoomView`:\
  - Attached to room prefabs.\
  - Holds references to:\
    - Door markers (`DoorMarker` components).\
    - Spawn points (`SpawnPoint` components).\
  - Provides methods for Door/Room animations (open, lock, etc.).\
\
### CombatView\
\
Responsibilities:\
\
- Display damage numbers, hit flashes, crit indicators.\
- Show status effect icons on characters.\
- Show cast bars and cooldown overlays on ability icons.\
\
Implementation:\
\
- `CombatView` subscribes to `GameStateClient` combat events.\
- Uses **pre-configured UI element prefabs** for damage numbers etc., instantiated under existing canvases.\
\
## UI Architecture\
\
### Principles\
\
- All core UIs are created in Unity editor:\
  - `Canvas_MainMenu`\
  - `Canvas_Lobby`\
  - `Canvas_InDungeon`\
- No new Canvas objects or root UI hierarchies are created programmatically.\
- UI controller scripts:\
  - Expose serialized fields for each important UI element (linked via inspector).\
  - Subscribe to `GameStateClient` and `NetworkClient` events.\
  - Trigger messages (e.g. login, chat, start dungeon, cast ability).\
\
### Main UI Controllers\
\
- `MainMenuUIController`\
  - Handles login form, character select, character creation.\
- `LobbyUIController`\
  - Displays online players, party composition, lobby chat.\
  - Buttons for inviting players, ready up, start dungeon.\
- `DungeonHUDController`\
  - Displays HP/MP/Trance for local player.\
  - Ability hotbar (1\'964 or more slots).\
  - Party frames.\
  - Active status effects on player.\
- `ChatUIController`\
  - Shows chat log (scroll view).\
  - Input field + send button.\
  - Channels: Lobby, Party, Dungeon.\
\
### Input System\
\
- Use Unity\'92s Input System (or classic input if simpler initially).\
- Map actions:\
  - `MoveX`, `MoveY`\
  - `PrimaryAttack`\
  - `Ability1`\'96`Ability4`\
  - `Interact`\
  - `OpenInventory`\
  - `OpenCharacterPanel`\
- `InputManager`:\
  - Global MonoBehaviour that raises C# events for input actions.\
  - PlayerController and UI controllers subscribe to relevant events.\
\
## Scenes\
\
Recommended initial scenes:\
\
1. `Bootstrap`\
   - Contains `GameBootstrap`, `NetworkClient`, `GameStateClient` (if using a MonoBehaviour wrapper), `InputManager`, `AudioManager`, and optionally a UI root overlay that persists.\
\
2. `MainMenu`\
   - Contains `Canvas_MainMenu` and `MainMenuUIController`.\
\
3. `Lobby`\
   - Contains a simple top-down environment or static background.\
   - Contains `Canvas_Lobby` and `LobbyUIController`.\
\
4. `Dungeon`\
   - Contains:\
     - Base environment (empty container to which rooms are added).\
     - Camera with follow script.\
     - `Canvas_InDungeon` with HUD and other panels.\
     - `DungeonView`, `DungeonHUDController`, `ChatUIController`, etc.\
\
Scene transitions should be orchestrated by a central `SceneController` that responds to server messages (e.g., \'93DungeonStarted\'94 \uc0\u8594  load `Dungeon` scene).\
\
## Extensibility Notes\
\
- Client should remain mostly agnostic of game rules. It displays state sent by the server.\
- Use ScriptableObjects in `AdventureBot.Client.Content` to map identifiers (e.g. element IDs, ability IDs, enemy IDs) to:\
  - Icons\
  - Colors\
  - SFX/VFX prefabs\
- Editor tools to manage these ScriptableObjects are described in `05_DUNGEON_GENERATION_AND_EDITOR_TOOLS.md`.\
}